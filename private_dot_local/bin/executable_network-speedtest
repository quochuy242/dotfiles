#!/bin/bash

# Check notify-send availability 
if ! command -v notify-send &>/dev/null; then
  echo "notify-send not available. Please install libnotify (libnotify-bin)."
  exit 1
fi

# Check speedtest-cli availability
if ! command -v ~/.local/bin/speedtest-cli &>/dev/null; then
  notify-send "Speedtest" "speedtest-cli is not installed"
  exit 1
fi

# Notification ID (arbitrary number)
ID=242

# Run speedtest and update notification line by line
speedtest-cli --secure 2>&1 | tee /tmp/speedtest.log | while IFS= read -r line; do
  notify-send -i network-wireless --replace-id="$ID" "Speedtest running..." "$line"
done


# Parse final result
RESULT=$(cat /tmp/speedtest.log)
PING=$(echo "$RESULT" | grep "Hosted" | awk -F': ' '{print $2}' | awk '{print $1 " " $2}')
DOWNLOAD=$(echo "$RESULT" | grep "Download:" | awk '{print $2, $3}')
UPLOAD=$(echo "$RESULT" | grep "Upload:" | awk '{print $2, $3}')

# Final summary
notify-send -i network-wireless --replace-id="$ID" "Speedtest Finished" "Ping: $PING\nDownload: $DOWNLOAD\nUpload: $UPLOAD"

